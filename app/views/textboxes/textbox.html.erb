<!DOCTYPE html>
<html>
    <head>
        <title>Textitor</title>
        <script src="https://use.fontawesome.com/aac5c45839.js"></script>
    </head>

    <body>
        <div class="parent">
          <textarea class="docName" id="docName" rows="1" spellcheck="false"></textarea>
            <div class="btn-group" role="group">
                <button class="btn1" id="bold" style="font-size: 12px; font-weight: bold;">B</button>
                <button class="btn1" id="italic" style="font-weight: bold; font-style: italic; font-family: Times;">I</button>
                <button class="btn1" id="strikeThrough"><i class="fa fa-strikethrough"></i></button>
                <button class="btn1" id="alignLeft"><i class="fa fa-align-left"></i></button>
                <button class="btn1" id="alignCenter"><i class="fa fa-align-center"></i></button>
                <button class="btn1" id="alignRight"><i class="fa fa-align-right"></i></button>
                <button class="btn1" id="subscript"><i class="fa fa-subscript"></i></button>
                <button class="btn1" id="superscript"><i class="fa fa-superscript"></i></button>
                <button class="btn1" id="unorderedList"><i class="fa fa-list-ul"></i></button>
                <button class="btn1" id="orderedList"><i class="fa fa-list-ol"></i></button>

                <!-- adds an html dropdown menu, allows user to choose font size-->
                <p>Font: </p>
                <select class="select" onchange="execCommandWithArg('fontSize', this.value);">
                    <option  value ="1">8</option>
                    <option  value ="2">10</option>
                    <option  value ="3" selected="">12</option>
                    <option  value ="4">16</option>
                    <option  value ="5">20</option>
                    <option  value ="6">24</option>
                    <option  value ="7">30</option>
                </select>

                <!-- maybe a bit too complex to add a user input option here-->
                <p>Type:</p>
                <select class="select" onchange="execCommandWithArg('fontName', this.value);">
                    <option value="Arial">Arial</option>
                    <option value="Comic Sans">Comic Sans MS</option>
                    <option value="Courier">Courier</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Verdana">Verdana</option>
                </select>

                <button class="btn2" id="savePlain" onclick="saveToLocal('plain')">Save Plain</button>
                <button class="btn2" id="saveRich" onclick="saveToLocal('rich')">Save Rich</button>
                <button class="btn2" onclick="upload();">Upload</button>
                <input class="btn2" type="file" id="upload" style="display: none;" onchange="loadFromLocal(this.files)" accept="text/plain,text/html"></input>

            <!-- need to restlyle the divs in this section-->
            </div>

            <div style="width: 100%; height: 1px;"></div>
            <iframe id="richTE"></iframe>
        </div>

        <script type="text/javascript">
            var iframe = document.getElementById("richTE").contentWindow;
            var textbox = iframe.document.body;
            var docName = document.getElementById("docName");
            docName.value = "Untitled";

            iframe.document.designMode = "On";
            textbox.style.wordWrap = 'break-word';
            textbox.innerText = "\n";
            textbox.focus();

            iframe.onload = function() {
                iframe.document.designMode = "On";
                textbox.style.wordWrap = 'break-word';
                textbox.innerText = "\n";
                iframe.focus();
            }

            document.onkeydown = function(e) {
                if (e.which == 9) e.preventDefault();
            }

            iframe.onkeydown = function(e) {
                logValues();
                console.log(e.keyCode);
                if (e.ctrlKey) {
                    if (e.keyCode == 66) {
                        console.log("preventDefault");
                        e.preventDefault();
                        document.getElementById("bold").click();
                    } else if(e.keyCode == 73) {
                        e.preventDefault();
                        document.getElementById("italic").click();
                    } else if(e.keyCode == 76) {
                        e.preventDefault();
                        document.getElementById("alignLeft").click();
                    } else if(e.keyCode == 69) {
                        e.preventDefault();
                        document.getElementById("alignCenter").click();
                    } else if(e.keyCode == 82) {
                        e.preventDefault();
                        document.getElementById("alignRight").click();
                    } else if(e.keyCode == 55) {
                        e.preventDefault();
                        document.getElementById("unorderedList").click();
                    } else if(e.keyCode == 56) {
                        e.preventDefault();
                        document.getElementById("orderedList").click();
                    } else if(e.keyCode == 83) {
                        e.preventDefault();
                        document.getElementById("saveRich").click();
                    } else if(e.keyCode == 80) {
                        e.preventDefault();
                        document.getElementById("savePlain").click();
                    } else if(e.keyCode == 85) {
                        e.preventDefault();
                        document.getElementById("upload").click();
                    }
                }
            }

            iframe.onkeyup = function() {setShadeByCursor();}
            iframe.onclick = function() {setShadeByCursor();}

            function setShadeByCursor() {

            }

            function toggleShade(element) {
                if (element.style.backgroundColor != "grey") element.style.backgroundColor = "grey";
                else element.style.backgroundColor = "#eeeeee";
            }

            //the first element in the array gets toggled
            function switchShade(element, otherElements) {
                toggleShade(element);
                for (i = 0; i < otherElements.length; i++) otherElements[i].style.backgroundColor = "#eeeeee";
            }

            function execCmd(command) {
                iframe.document.execCommand(command, false, null);
                textbox.focus();
            }

            function execCommandWithArg(command, arg) {
                iframe.document.execCommand(command, false, arg);
                textbox.focus();
            }

            function getCursorPosition(element) {
                var doc = element.ownerDocument;
                var win = doc.defaultView;
                var sel, range, preCaretRange, caretOffset = 0;
                sel = win.getSelection();
                console.log(sel);
                range = sel.getRangeAt(0);
                preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(element);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                caretOffset = preCaretRange.toString().length;

                return caretOffset;
            }

            function upload() {document.getElementById("upload").click();}
            function loadFromLocal(files) {
                var file = files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.readAsText(file, "UTF-8");
                    reader.onload = function (evt) {
                        if (file.name.includes(".txt")) {
                            iframe.innerText = evt.target.result;
                            if (iframe.innerText) iframe.innerText = evt.target.result;
                            docName.value = file.name.substring(0, file.name.length - 4);
                        } else if (file.name.includes(".html")) {
                            iframe.innerHTML = evt.target.result;
                            if (iframe.innerText) iframe.innerHTML = evt.target.result;
                            docName.value = file.name.substring(0, file.name.length - 5);
                        } else if (file.name.includes(".rtx")) {
                            iframe.innerHTML = evt.target.result;
                            if (iframe.innerText) iframe.innerHTML = evt.target.result;
                            docName.value = file.name.substring(0, file.name.length - 4);
                        } else alert("Wrong file format");
                    }
                    reader.onerror = function (evt) {
                        alert("Error loading file");
                    }
                }
            }

            function saveToLocal(textType) {
                var text = "";
                var fileName = docName.value;
                if (textType === "plain") {
                    fileName = fileName + ".txt";
                    text = textbox.innerText;
                } else {
                    fileName = fileName + ".rtx";
                    text = textbox.innerHTML;
                }

                var downloadLink = document.createElement("a");
                downloadLink.download = fileName;
                downloadLink.innerHTML = "Download File";
                downloadLink.href = window.URL.createObjectURL(new Blob([text], {type:"text/plain"}));
                downloadLink.onclick = destroyClickedElement;
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);

                function destroyClickedElement(event) {
                    document.body.removeChild(event.target);
                }

                downloadLink.click();
            }



            function saveToDatabase() {

            }

            function loadFromDatabase() {

            }

            document.getElementById("bold").onclick = function() {
                execCmd('bold');
                toggleShade(this);
            }

            document.getElementById("italic").onclick = function() {
                execCmd('italic');
                toggleShade(this);
            }

            document.getElementById("strikeThrough").onclick = function() {
                execCmd('strikethrough');
                toggleShade(this);
            }

            document.getElementById("alignLeft").onclick = function() {
                execCmd('justifyleft');
                console.log(document.getElementById("alignCenter"));
                console.log(document.getElementById("alignRight"));
                switchShade(this, [document.getElementById("alignCenter"), document.getElementById("alignRight")]);
            }

            document.getElementById("alignCenter").onclick = function() {
                execCmd('justifycenter');
                switchShade(this, [document.getElementById("alignLeft"), document.getElementById("alignRight")]);
            }

            document.getElementById("alignRight").onclick = function() {
                execCmd('justifyright');
                console.log(document.getElementById("alignCenter"));
                console.log(document.getElementById("alignRight"));
                switchShade(this, [document.getElementById("alignLeft"), document.getElementById("alignCenter")]);
            }

            document.getElementById("subscript").onclick = function() {
                execCmd('subscript');
                switchShade(this, [document.getElementById("superscript")]);
            }

            document.getElementById("superscript").onclick = function() {
                execCmd('superscript');
                switchShade(this, [document.getElementById("subscript")]);
            }

            document.getElementById("unorderedList").onclick = function() {
                execCmd('insertUnorderedList');
                switchShade(this, [document.getElementById("orderedList")]);
            }

            document.getElementById("orderedList").onclick = function() {
                execCmd('insertOrderedList');
                switchShade(this, [document.getElementById("unorderedList")]);
            }

            function logValues() {
                console.log({"text": textbox.innerText, "html": textbox.innerHTML});
            }
        </script>
    </body>
</html>
